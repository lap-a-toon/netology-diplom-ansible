---
- name: Update web servers
  hosts: web
  become: true
  tasks:
    - name: test
      debug:
        msg: "Ehlo!"
    - name: Run the equivalent of "apt-get update" as a separate step
      ansible.builtin.apt:
        update_cache: yes
    - name: Install a list of packages
      ansible.builtin.apt:
        pkg:
        - nginx
        - git
    - name: Download site from repo
      git:
        repo: https://github.com/lap-a-toon/Rasschet-kartochek-dlya-tuniketa-SATURN-TEC.git
        dest: /var/www/html
        update: yes
    - name: create service node-exporter
      template:
        src: etc/systemd/system/node-exporter.service.j2
        dest: /etc/systemd/system/node-exporter.service
- name: Installing Prometheus
  hosts: prometheus
  become: true
  tasks:
    - name: copy install script prometheus
      template:
        src: install_prometheus.sh.j2
        dest: install_prometheus.sh
    - name: run install script prometheus
      command: bash ./install_prometheus.sh
    - name: config prometheus
      template:
        src: etc/prometheus/prometheus.j2
        dest: /etc/prometheus/prometheus.yml
    - name: create service prometheus
      template:
        src: etc/systemd/system/prometheus.service.j2
        dest: /etc/systemd/system/prometheus.service
    - name: Start service prometheus, in all cases
      ansible.builtin.service:
        name: prometheus.service
        state: restarted
- name: install node-exporter
  hosts: node-exporter
  become: true
  tasks:
    - name: copy install script node-exporter
      template:
        src: install_node-exporter.sh.j2
        dest: install_node-exporter.sh
    - name: run install script node-exporter
      command: bash ./install_node-exporter.sh
    - name: create service node-exporter
      template:
        src: etc/systemd/system/node-exporter.service.j2
        dest: /etc/systemd/system/node-exporter.service
    - name: Enable service node-exporter, in all cases
      ansible.builtin.service:
        name: node-exporter.service
        enabled: yes
    - name: Start service node-exporter, in all cases
      ansible.builtin.service:
        name: node-exporter.service
        state: restarted
